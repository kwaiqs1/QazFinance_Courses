{% extends "base.html" %}
{% load academy_extras %}
{% block title %}{{ lesson.title }} — {{ course.title }}{% endblock %}
{% block content %}

<div class="row g-4">
  <!-- Sidebar -->
  <div class="col-lg-4 col-xl-3">
    <div class="glass-card p-3 p-lg-4 sticky-lg-top" style="top: 92px;">
      <div class="d-flex align-items-start justify-content-between gap-2 mb-2">
        <div>
          <div class="text-white fw-bold">Навигация</div>
          <div class="text-white-50 small">{{ course.title }}</div>
        </div>
        <span class="tag">Khan‑style</span>
      </div>

      <div class="divider my-3"></div>

      <div class="sidebar-scroll">
        {% for item in sidebar %}
          <div class="mb-3">
            <div class="text-white-50 small mb-2">{{ item.unit.title }}</div>
            <div class="list-group list-group-dark">
              {% for row in item.lessons %}
                {% with l=row.lesson p=row.progress %}
                <a class="list-group-item list-group-item-action d-flex align-items-center justify-content-between
                          {% if l.id == lesson.id %}active{% endif %}"
                   href="/academy/course/{{ course.slug }}/lesson/{{ l.id }}/">
                  <div class="d-flex align-items-center gap-2">
                    <span class="lesson-dot {% if p and p.completed %}done{% elif p %}mid{% else %}none{% endif %}"></span>
                    <span class="text-truncate">{{ l.title }}</span>
                  </div>
                  <span class="badge badge-mini">
                    {% if p %}{{ p.best_score|floatformat:0 }}%{% else %}—{% endif %}
                  </span>
                </a>
                {% endwith %}
              {% endfor %}
            </div>
          </div>
        {% endfor %}
      </div>

      <div class="divider my-3"></div>

      <div class="d-flex gap-2">
        {% if prev_lesson %}
          <a class="btn btn-outline-light btn-sm w-50" href="/academy/course/{{ course.slug }}/lesson/{{ prev_lesson.id }}/">
            <i class="bi bi-arrow-left"></i> Назад
          </a>
        {% else %}
          <button class="btn btn-outline-light btn-sm w-50" disabled><i class="bi bi-arrow-left"></i> Назад</button>
        {% endif %}

        {% if next_lesson %}
          <a class="btn btn-gold btn-sm w-50" href="/academy/course/{{ course.slug }}/lesson/{{ next_lesson.id }}/">
            Далее <i class="bi bi-arrow-right"></i>
          </a>
        {% else %}
          <button class="btn btn-gold btn-sm w-50" disabled>Далее <i class="bi bi-arrow-right"></i></button>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Main -->
  <div class="col-lg-8 col-xl-9">
    <div class="glass-card p-4 p-lg-5">

      <div class="d-flex flex-column flex-md-row align-items-md-start justify-content-between gap-3 mb-4">
        <div>
          <div class="text-white-50 small mb-1">{{ course.title }}</div>
          <h1 class="h3 text-white mb-0">{{ lesson.title }}</h1>
        </div>

        <div class="text-end">
          <div class="text-white-50 small">Прогресс урока</div>
          {% if progress %}
            <div class="d-flex flex-wrap gap-2 justify-content-md-end">
              <span class="badge text-bg-dark border border-light-subtle px-3 py-2">best: {{ progress.best_score|floatformat:1 }}%</span>
              <span class="badge text-bg-dark border border-light-subtle px-3 py-2">last: {{ progress.last_score|floatformat:1 }}%</span>
              {% if progress.completed %}
                <span class="badge text-bg-success px-3 py-2">completed</span>
              {% else %}
                <span class="badge text-bg-warning px-3 py-2">in progress</span>
              {% endif %}
            </div>
          {% else %}
            <div class="badge text-bg-secondary px-3 py-2">not started</div>
          {% endif %}
        </div>
      </div>

      <!-- Sections -->
      <div class="lesson-section mb-4">
        <div class="section-head">
          <i class="bi bi-bullseye"></i>
          <div>
            <div class="title">Цели урока</div>
            <div class="subtitle">Что вы должны уметь после прохождения</div>
          </div>
        </div>
        <div class="section-body">
          {% if lesson.objectives %}{{ lesson.objectives|safe }}{% else %}<span class="text-white-50">—</span>{% endif %}
        </div>
      </div>

      <div class="lesson-section mb-4">
        <div class="section-head">
          <i class="bi bi-journal-text"></i>
          <div>
            <div class="title">Теория</div>
            <div class="subtitle">Основной контент</div>
          </div>
        </div>
        <div class="section-body">
          {% if lesson.theory %}{{ lesson.theory|safe }}{% else %}<span class="text-white-50">—</span>{% endif %}
        </div>
      </div>

      {% if lesson.numbers %}
      <div class="lesson-section mb-4">
        <div class="section-head">
          <i class="bi bi-calculator"></i>
          <div>
            <div class="title">Опора на цифры / формулы</div>
            <div class="subtitle">Ключевые величины и правила</div>
          </div>
        </div>
        <div class="section-body">
          {{ lesson.numbers|safe }}
        </div>
      </div>
      {% endif %}

      <div class="lesson-section mb-4">
        <div class="section-head">
          <i class="bi bi-ui-checks-grid"></i>
          <div>
            <div class="title">Практика</div>
            <div class="subtitle">Тестовые вопросы (3 варианта, 1 правильный)</div>
          </div>
        </div>
        <div class="section-body">

          {% if questions %}
            <form method="post" class="quiz">
              {% csrf_token %}

              {% if result %}
                <div class="quiz-result p-3 mb-3">
                  <div class="text-white fw-semibold">Ваш результат: {{ result.score }}%</div>
                  <div class="text-white-50 small">Правильных: {{ result.correct }} из {{ result.total }}</div>
                </div>
              {% endif %}

              {% for q in questions %}
                <div class="quiz-q mb-4">
                  <div class="text-white fw-semibold mb-2">{{ forloop.counter }}. {{ q.text }}</div>
                  <div class="d-grid gap-2">
                    {% for ch in q.choices.all %}
                      <label class="choice">
                        <input type="radio" name="q_{{ q.id }}" value="{{ ch.id }}"
                          {% if selected_answers|get_item:q.id == ch.id %}checked{% endif %}>
                        <span>{{ ch.text }}</span>
                      </label>
                    {% endfor %}
                  </div>

                  {% if result %}
                    {% with correct_choice=q.choices.all|dictsortreversed:"is_correct"|first %}
                    {% endwith %}
                  {% endif %}
                </div>
              {% endfor %}

              <button class="btn btn-gold btn-lg" type="submit"><i class="bi bi-check2-circle"></i> Проверить и сохранить</button>
            </form>
          {% else %}
            <div class="alert alert-warning mb-0">Вопросы для урока пока не добавлены.</div>
          {% endif %}
        </div>
      </div>

      <div class="lesson-section mb-4">
        <div class="section-head">
          <i class="bi bi-briefcase"></i>
          <div>
            <div class="title">Кейс</div>
            <div class="subtitle">Применение в реальной ситуации</div>
          </div>
        </div>
        <div class="section-body">
          {% if lesson.case %}{{ lesson.case|safe }}{% else %}<span class="text-white-50">—</span>{% endif %}
        </div>
      </div>

      <div class="lesson-section">
        <div class="section-head">
          <i class="bi bi-flag"></i>
          <div>
            <div class="title">Итоги</div>
            <div class="subtitle">Короткая фиксация ключевых идей</div>
          </div>
        </div>
        <div class="section-body">
          {% if lesson.summary %}{{ lesson.summary|safe }}{% else %}<span class="text-white-50">—</span>{% endif %}
        </div>
      </div>

      <div class="divider my-4"></div>

      <div class="d-flex flex-wrap gap-2">
        <a class="btn btn-outline-light" href="/academy/course/{{ course.slug }}/"><i class="bi bi-layers"></i> К модулю</a>
        <a class="btn btn-outline-light" href="/academy/"><i class="bi bi-grid"></i> Все курсы</a>
      </div>

    </div>
  </div>
</div>

{% endblock %}
